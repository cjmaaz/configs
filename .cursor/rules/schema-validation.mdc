---
description: Before writing **any** Apex code, SOQL queries, DML operations, or LWC components that interact with Salesforce objects and fields, you **MUST** first consult the schema files located at **config/schema/** directory.
alwaysApply: false
---
# Salesforce Schema Validation Ruleset

## ‚ö†Ô∏è CRITICAL WARNING - ZERO TOLERANCE POLICY

**NEVER WRITE CODE BEFORE READING THE SCHEMA. NO EXCEPTIONS.**

### ‚ùå PROHIBITED Actions:
- ‚ùå **NEVER** write code before reading `config/schema/objects/<ObjectName>/schema.yaml`
- ‚ùå **NEVER** guess picklist values (even for standard Salesforce fields)
- ‚ùå **NEVER** skip validation due to time pressure or rapid implementation
- ‚ùå **NEVER** assume standard objects (Contact, Account, Lead, Case) use default picklist values
- ‚ùå **NEVER** write DML code without reading picklists.yaml if setting picklist fields

### ‚ö†Ô∏è Consequences:
- Deployment failures (INVALID_OR_NULL_FOR_RESTRICTED_PICKLIST)
- Runtime exceptions in production
- Multiple failed deployments

### ‚úÖ Exception: Ad-Hoc Data Inspection (NOT Code Development)

**When you CAN query Salesforce directly WITHOUT schema validation:**
- ‚úÖ Inspecting specific records (one-time investigation)
- ‚úÖ Debugging existing data (troubleshooting)
- ‚úÖ Verifying test results (confirming creation)
- ‚úÖ Discovering data patterns (when schema cannot help - use aggregate queries)

```bash
# Acceptable: Inspecting a specific record by ID
sf data record get --sobject Account --record-id 001XXXXXXXXXXXXXXX --target-org YourOrg

# Acceptable: Finding distinct values in text/formula fields
sf data query --query "SELECT COUNT(Id), Type FROM Account GROUP BY Type" --target-org YourOrg
```

**‚ùå When you MUST use schema validation (NO EXCEPTIONS):**
- Writing Apex classes/methods (including test data helpers)
- Creating SOQL queries in code (Apex, LWC, triggers)
- Performing DML operations in code
- Finding picklist values for code implementation

**Rule:** Writing **persistent code**? ‚Üí Schema first. Doing **one-time inspection**? ‚Üí Direct query is fine.

**Note:** When inspecting specific records by ID (e.g., provided as examples), always use `sf data record get` or `sf data query` directly rather than creating temporary scripts.

---
## üéØ Golden Rule

**Schema first, code second. ALWAYS. ‚úÖ**

```bash
# ALWAYS do this first when writing code:
read_file config/schema/objects/<ObjectName>/schema.yaml
# THEN, if setting picklist values:
read_file config/schema/objects/<ObjectName>/picklists.yaml
# THEN write code
```

Applies to:
- ‚úÖ Standard objects (Account, Contact, Opportunity, Case, Lead)
- ‚úÖ Custom objects (MyCustomObject__c)
- ‚úÖ Creating 1 object or 100 objects
- ‚úÖ Fields you "think" you know

---
## 3-Step Validation Workflow

### Step 1: Read Core Schema (MANDATORY)
```bash
read_file config/schema/objects/<ObjectName>/schema.yaml
```

**Extract:**
- Field API names (exact, case-sensitive)
- Field types (Text, Picklist, Lookup, Number, etc.)
- Required fields, field lengths, relationship names
- **Note:** Picklist fields are marked as type "Picklist" but values are in separate file

**‚ö†Ô∏è CRITICAL:** Even standard objects have **ORG-SPECIFIC** configurations. Never assume defaults.

### Step 2: Read Picklist Values (IF NEEDED)
**Read picklists.yaml when:**
- Writing DML operations (insert/update with picklist fields)
- Setting picklist field values in code
- Validating user input for picklist fields
- Need to know valid picklist options

```bash
# Only if object has picklist fields and you need the values
read_file config/schema/objects/<ObjectName>/picklists.yaml
```

**Skip if:** You're only querying data or working with non-picklist fields.

### Step 3: Read Formula Definitions (IF NEEDED)
**Read formulas.yaml when:**
- Understanding calculated field logic
- Debugging formula errors
- Determining field dependencies
- Need to know how a value is computed

```bash
# Only if object has formulas and you need to understand them
read_file config/schema/objects/<ObjectName>/formulas.yaml
```

**Skip if:** You're not working with formula fields.

---
## Multi-Object Workflow (10+ Objects)

```bash
# Step 1: Batch-read all core schemas (parallel tool calls)
read_file config/schema/objects/Account/schema.yaml
read_file config/schema/objects/Contact/schema.yaml
read_file config/schema/objects/Opportunity/schema.yaml
```

```bash
# Step 2: Read picklists ONLY for objects where you're setting picklist values
read_file config/schema/objects/Account/picklists.yaml
read_file config/schema/objects/Opportunity/picklists.yaml
```

```apex
// Step 3: Document picklist values you'll use
// Account.Type: Prospect, Customer, Partner
// Opportunity.StageName: Prospecting, Qualification, Closed Won

// Step 4: Write code with validated values
```

---
## SOQL Relationship Rules

**Standard lookup fields** (no `__r` suffix):
```apex
// Field: AccountId ‚Üí Relationship: Account
SELECT Id, Account.Name FROM Contact  // ‚úÖ CORRECT
SELECT Id, Account__r.Name FROM Contact  // ‚ùå WRONG
```

**Custom lookup fields** (with `__r` suffix):
```apex
// Field: CustomLookup__c ‚Üí Relationship: CustomLookup__r
SELECT Id, CustomLookup__r.Name FROM MyObject__c  // ‚úÖ CORRECT
```

**Child queries:**
```apex
// Schema shows child relationship: Contacts
SELECT Id, (SELECT FirstName FROM Contacts) FROM Account  // ‚úÖ CORRECT
SELECT Id, (SELECT FirstName FROM Contact) FROM Account  // ‚ùå WRONG
```

**Always verify `relationship_name` in schema.**

---
## Example: SOQL + DML with Schema Validation

### Step 1: Read Core Schema
```bash
read_file config/schema/objects/Opportunity/schema.yaml
```

### Step 2: Read Picklists (for DML operation)
```bash
read_file config/schema/objects/Opportunity/picklists.yaml
```

### Step 3: Review Schema & Picklists
**From schema.yaml:**
```yaml
- api_name: StageName
  type: Picklist
  required: false
- api_name: AccountId
  type: Lookup
  reference_to: Account
  relationship_name: Account
```

**From picklists.yaml:**
```yaml
picklists:
  StageName:
  - Prospecting
  - Qualification
  - Closed Won
```

### Step 4: Write Code
```apex
// ‚úÖ CORRECT: All fields validated
List<Opportunity> opps = [
    SELECT Id, Name, StageName, Account.Name
      FROM Opportunity WHERE StageName = 'Prospecting'
];

Opportunity newOpp = new Opportunity();
newOpp.Name = 'Q1 Deal';
newOpp.StageName = 'Prospecting';  // ‚úÖ Valid from picklists.yaml
newOpp.CloseDate = Date.today().addDays(30);
insert newOpp;
```

### ‚ùå WRONG: Without Schema
```apex
// ‚ùå WRONG: Guessed values
List<Opportunity> opps = [
    SELECT Id, Stage, AccountName.Name  // ‚ùå Wrong fields!
      FROM Opportunity
];
Opportunity newOpp = new Opportunity();
newOpp.StageName = 'Open';  // ‚ùå Invalid picklist value!
insert newOpp;  // ‚ùå FAILS at runtime
```

---
## Picklist Value Lookup

### ‚úÖ PRIMARY SOURCE
**Picklists are in a separate file for each object:**

**Step 1: Read schema to see which fields are picklists**
```bash
read_file config/schema/objects/Case/schema.yaml
```

**Step 2: Read picklist values**
```bash
read_file config/schema/objects/Case/picklists.yaml
```

**From picklists.yaml:**
```yaml
picklists:
  Priority:
    - Low
    - Medium
    - High
  Status:
    - New
    - Working
    - Escalated
    - Closed
```

```apex
myCase.Priority = 'High';  // ‚úÖ Validated from picklists.yaml
myCase.Status = 'New';     // ‚úÖ Validated from picklists.yaml
```

### ‚ùå NEVER
```apex
myCase.Priority = 'Important';  // ‚ùå Guessed value (not in schema)
myCase.Status = 'Active';  // ‚ùå Assumed standard default
```

### ‚ö†Ô∏è LAST RESORT: Missing Schema Values
**Only when picklists.yaml doesn't exist or is empty:**
```bash
# Step 1: Confirm picklists.yaml is missing or empty
ls config/schema/objects/Case/picklists.yaml  # File not found

# Step 2: Query production (LAST RESORT)
sf data query --query "SELECT Priority FROM Case WHERE Priority != null GROUP BY Priority" -o YourOrg
```

```apex
// ‚ö†Ô∏è WARNING: Schema incomplete. Queried production: Low, Medium, High
myCase.Priority = 'High';
```

---
## Real-World Failure Examples

**Note:** Examples use generic Sales/Service Cloud objects. YOUR org's values may differ.

### ‚ùå Example 1: Guessing Picklist Values
**WRONG:**
```apex
Lead lead = new Lead();
lead.Status = 'New Lead';  // ‚ùå Guessed
insert lead;
// Result: ‚ùå INVALID_OR_NULL_FOR_RESTRICTED_PICKLIST
```

**CORRECT:**
```bash
# Step 1: Read core schema
read_file config/schema/objects/Lead/schema.yaml
# Step 2: Read picklist values
read_file config/schema/objects/Lead/picklists.yaml
```
**From picklists.yaml:**
```yaml
picklists:
  Status:
    - Open - Not Contacted
    - Working - Contacted
```
```apex
lead.Status = 'Open - Not Contacted';  // ‚úÖ From picklists.yaml
insert lead;  // ‚úÖ SUCCESS
```

### ‚ùå Example 2: Wrong Relationship Name
**WRONG:**
```apex
SELECT Id, AccountName.Name FROM Contact  // ‚ùå Wrong relationship
// Result: ‚ùå COMPILATION ERROR
```

**CORRECT:**
```bash
read_file config/schema/objects/Contact/schema.yaml
```
**From schema.yaml:**
```yaml
- api_name: AccountId
  type: Lookup
  reference_to: Account
  relationship_name: Account  # ‚úÖ Use this
```
```apex
SELECT Id, Account.Name FROM Contact  // ‚úÖ From schema - SUCCESS
```

### ‚ùå Example 3: Exceeding Text Length
**WRONG:**
```apex
Case c = new Case();
c.Subject = 'This is a very long subject that exceeds...';  // ‚ùå Too long
insert c;  // Result: ‚ùå STRING_TOO_LONG
```

**CORRECT:**
```bash
read_file config/schema/objects/Case/schema.yaml
```
**From schema.yaml:**
```yaml
- api_name: Subject
  type: Text
  length: 255  # ‚úÖ Max length
```
```apex
c.Subject = 'Customer Issue';  // ‚úÖ Within limit - SUCCESS
```

---
## Common Mistakes

| Mistake | Correct Approach |
|---------|------------------|
| Guessing picklist values | Read `objects/<ObjectName>/picklists.yaml` |
| Assuming standard defaults | Validate org-specific values in picklists.yaml |
| Wrong relationship name | Check `relationship_name` in schema.yaml |
| Exceeding text length | Check `length` property in schema.yaml |
| Skipping validation | Always read schema.yaml first |
| Reading all files unnecessarily | Read picklists/formulas only when needed |

---
## Schema File Locations

| Purpose | File Path | When to Read |
|---------|-----------|--------------|
| **Core structure** | `config/schema/objects/<ObjectName>/schema.yaml` | **ALWAYS** - First step for any code |
| **Picklist values** | `config/schema/objects/<ObjectName>/picklists.yaml` | When setting picklist fields in DML operations |
| **Formula definitions** | `config/schema/objects/<ObjectName>/formulas.yaml` | When understanding calculated field logic |
| **Object index** | `config/schema/_index.yaml` | To check if object exists and see available files |
| ‚ùå **DO NOT USE** | `config/salesforce-er-schema.yaml` | Too large (1.3 MB), use split files instead |

---
## Validation Checklist

- [ ] Read `config/schema/objects/<ObjectName>/schema.yaml`
- [ ] Field API names match schema (case-sensitive)
- [ ] If setting picklist fields: Read `config/schema/objects/<ObjectName>/picklists.yaml`
- [ ] Picklist values in `picklists.yaml` (not guessed)
- [ ] Required fields populated
- [ ] Text values within `length` limit
- [ ] Relationship names correct (from schema.yaml)
- [ ] If working with formulas: Read `config/schema/objects/<ObjectName>/formulas.yaml` (optional)

---
## Quick Reference

```bash
# MANDATORY WORKFLOW:
# 1. Read core schema (ALWAYS)
read_file config/schema/objects/<ObjectName>/schema.yaml

# 2. Read picklists (IF setting picklist field values)
read_file config/schema/objects/<ObjectName>/picklists.yaml

# 3. Read formulas (IF understanding formula logic)
read_file config/schema/objects/<ObjectName>/formulas.yaml

# 4. Document values you'll use (e.g., Account.Type: Prospect, Customer)
# 5. Write code with validated values
```

**Efficient reading: Start with schema.yaml, add others only when needed.**

**Schema first, code second. ALWAYS. ‚úÖ**

---
## Enforcement

**ZERO TOLERANCE for violations.**

**MUST:**
1. Read schema file first
2. Validate all picklist values
3. Validate all field types
4. Check required fields

**Applies to:**
- All standard and custom objects
- 1 object or 100 objects
- Under time pressure or not
- Fields you "think" you know

**No exceptions. No shortcuts. No guessing.**
---
